{% extends 'layout.html' %}
{% block content %}
<div class="content-section">
	<form method="POST" action="">
		{{ form.hidden_tag() }}
		<fieldset class="form-group">
			<legend class="border-bottom mb-4">{{ title }}</legend>
			<div class="form-group">
				{{ form.link.label(class='form-control-label') }}
				{% if form.link.errors %}
					{{ form.link(class='form-control form-control-lg is-invalid') }}
					<div class="invalid-feedback">
						{% for error in form.link.errors %}
							<span>{{ error }}</span>
						{% endfor %}
					</div>
				{% else %}
					{{ form.link(class='form-control form-control-lg') }}
				{% endif %}
			</div>
			<div class="form-group">
				{{ form.optimal_price.label(class='form-control-label') }}
				{% if form.optimal_price.errors %}
					{{ form.optimal_price(class='form-control form-control-lg is-invalid') }}
					<div class="invalid-feedback">
						{% for error in form.optimal_price.errors %}
							<span>{{ error }}</span>
						{% endfor %}
					</div>
				{% else %}
					{{ form.optimal_price(class='form-control form-control-lg') }}
				{% endif %}
			</div>
		</fieldset>
		<div class="form-group">
			{{ form.submit(class='btn btn-outline-info') }}
		</div>
	</form>
</div>

{% endblock content %}

{% block js %}
<script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
<script type="text/javascript">
	$(document).ready(function() {
		$('form').on('submit', function(e) {
			e.preventDefault();
			my_url = "{{ url_for('products.add_product') }}";
			$.ajax({
				data: $('form').serialize(),
				type: 'POST',
				url: '/product/add',
                success: function (data) {
                	if (data.error) {
                		// TODO: Error handling.
                		alert("Whoopsie!");
                		console.log(data.error);
                	} else {
                		check_job_status(data.location);
                	}
                }
			});
		});
	});

	function check_job_status(status_url) {
		console.log("checking...");
		$.getJSON(status_url, function(data) {
		    switch (data.status) {
				case "unknown":
					alert("Unknown job");
					break;
				case "finished":
					window.location.replace("{{ url_for('main.home') }}");
		          	break;
				case "failed":
					alert("Job failed");
					break;
				case "invalid":
					alert("Invalid user. Make sure it exists and has reviews.");
					break;
				default:
					console.log("1 sec wait");
					setTimeout(function() {
						check_job_status(status_url);
					}, 1000);
	    	}
	    });
	}
</script>
{% endblock js %}