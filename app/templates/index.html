{% extends 'layout.html' %}

{% block content %}
	<div class="product-board card-columns">
	{% for product in products.items %}
		<div class="card product-item">
			<img src="{{ product.img }}" class="card-img-top">
			<div class="card-body">
				{% if product.name|length > 375 %}
					<h5 class="card-title">{{ product.name[:75] }}...</h5>
				{% else %}
					<h5 class="card-title">{{ product.name }}</h5>
				{% endif %}
				<p class="card-text">Current price: {{ product.current_price }} {{ product.currency_code }}
					<br>
					Your preferred price: {{ product.optimal_price }} {{ product.currency_code }}</p>
				<div class="btn-section text-center">
					<a href="{{ product.link }}" class="btn btn-primary" target="_blank">Buy</a>
					<button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#editModal" data-current-price="{{ product.current_price }}" data-optimal-price="{{ product.optimal_price }}" data-currency-code="{{ product.currency_code }}" data-url="{{ url_for('products.update_product', product_id=product.id) }}">Edit</button>
					<button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteModal" data-url="{{ url_for('products.delete_product', product_id=product.id) }}" data-price="{{ product.optimal_price }}" data-name="{{ product.name }}">Delete</button>
				</div>
			</div>
		</div>
	{% endfor %}
	</div>

<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="deleteModalLabel">Delete Product</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<p>Are you sure you want to delete this product?</p>
				<p class="product-name"></p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				<form action="#" method="POST" id="modal-form">
					<input class="btn btn-danger" type="submit" value="Delete">
				</form>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="editModalLabel">Edit Product Price</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="row" style="height: 1rem;"></div>
			<form method="POST" action="" id="edit-form">
				{{ form.hidden_tag() }}
				<div class="form-group row">
					<label for="currentPrice" class="col-sm-5 col-form-label text-right" style="">Current price: </label>
					<div class="col-sm-6">
						<input type="text" readonly class="form-control-plaintext" id="currentPrice" value="Unknown">
					</div>
					<div class="col-sm-1"></div>
				</div>
				<div class="form-group row">
					<label for="optimalPrice" class="col-sm-5 col-form-label text-right" style="">Your preferred price: </label>
					<div class="col-sm-6">
						<input type="text" readonly class="form-control-plaintext" id="optimalPrice" value="Unknown">
					</div>
					<div class="col-sm-1"></div>
				</div>
				<div class="form-group row">
					<label for="newPrice" class="col-sm-5 col-form-label text-right">Your new price: </label>
					<div class="col-sm-6">
						<!-- <input type="number" step="0.01" class="form-control" id="newPrice" placeholder="0.00"> -->
						{{ form.optimal_price(class='form-control', id='optimal-price-input') }}
						<div class="invalid-feedback" id="invalid-feedback-div"></div>
					</div>
					<div class="col-sm-1"></div>
				</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				<button type="submit" class="btn btn-primary">Save changes</button>
			</div>
			</form>
		</div>
	</div>
</div>

{% endblock content %}

{% block js %}
<script type="text/javascript">
	// TODO: On document ready

	$('#deleteModal').on('show.bs.modal', function(event) {
		var button = $(event.relatedTarget);
		var url = button.data('url');
		var price = button.data('price');
		var name = button.data('name');
		modal = $(this);
		modal.find('.modal-footer form').attr('action', url);
		modal.find('.modal-body .product-name').text(name);
	});

	var url = "";

	$('#editModal').on('show.bs.modal', function(event) {
		var button = $(event.relatedTarget);
		var current_price = button.data('current-price');
		var optimal_price = button.data('optimal-price');
		var currency_code = button.data('currency-code');
		url = button.data('url');
		$('#currentPrice').val(current_price + " " + currency_code);
		$('#optimalPrice').val(optimal_price + " " + currency_code);
		// $('#newPrice').val(parseFloat(optimal_price));
		modal = $(this);
		modal.find('.modal-content form').attr('action', url);
	});

	$('#edit-form').on('submit', function(e) {
		e.preventDefault();
		$.ajax({
			data: $('#edit-form').serialize(),
			type: 'POST',
			url: url,
            success: function(data) {
            	if (data.error) {
            		console.log(data.error);
            		$('#optimal-price-input').addClass('is-invalid');
            		var error_span = document.createElement('span');
            		error_span.innerText = "The price must be a valid amount of money.";
            		$('#invalid-feedback-div').append(error_span);
            	} else {
            		window.location.href = "{{ url_for('main.home') }}";
            	}
            }
		});
	});
</script>
{% endblock js %}